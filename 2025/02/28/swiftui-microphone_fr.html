<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title></title>
    <meta name="description" content="" />
    <meta name="author" content="Alexandre Bintz" />

    <meta property="og:title" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta property="og:locale" content="" />
    <meta property="og:type" content="website" />
    
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="" />

    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="/assets/css/custom.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Alexandre Bintz" /><link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
</head><body><header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" rel="author" href="/">Alexandre Bintz</a>

    <!--
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a class="page-link" href="/interests">Interests</a>
        <a class="page-link" href="/projects">Projects</a>
        <a class="page-link" href="/blog">Blog</a>
      </div>
    </nav>
    -->
    
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">(fr) Acc√®s au micro dans une app SwiftUI</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-02-28T04:02:15-06:00" itemprop="datePublished">Feb 28, 2025
      </time></p>
      
      
        <div class="post-topics">
          
            <a href="/programming"><i>#programming</i></a>
          
        </div>
      
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>J‚Äôai une activit√© de vente en ligne de pi√®ces de LEGO sur la plateforme BrickLink,
et je d√©veloppe une application mac en SwiftUI pour m‚Äôaider √† g√©rer mes ventes.</p>

<p>Pour le module d‚Äôaide au picking, j‚Äôai imagin√© une fonctionnalit√© mains libre bas√©e sur des commandes vocales.
Dans cette optique, j‚Äôai commenc√© par exp√©rimenter avec le module de reconnaissance vocale d‚ÄôApple.
Mais au pr√©alable, il faut acc√©der aux donn√©es audio du micro.</p>

<p>Dans cet article je reviens sur comment j‚Äôai impl√©ment√© l‚Äôacc√®s au micro dans une application Swift UI.</p>

<h2 id="pr√©paration">Pr√©paration</h2>

<p>Pour que l‚Äôapp puisse avoir acc√®s au micro, il faut cocher <strong>Audio Input</strong> dans <strong>Signing &amp; Capabilities</strong>, et ajouter la cl√© <strong>NSMicrophoneUsageDescription</strong> dans l‚Äôonglet <strong>Info</strong>.</p>

<h2 id="structure-de-base">Structure de base</h2>

<p>Mon app de test comprend une seule vue, avec un bouton pour lancer/arr√™ter l‚Äô√©coute du micro.
Les fonctionnalit√©s d‚Äôacc√®s au micro sont g√©r√©es dans un objet contr√¥leur <code class="language-plaintext highlighter-rouge">@Observable</code> utilis√© comme <code class="language-plaintext highlighter-rouge">@State</code> dans la vue. Le contr√¥leur expose des fonctions <code class="language-plaintext highlighter-rouge">start()</code> et <code class="language-plaintext highlighter-rouge">stop()</code>, et une propri√©t√© observable <code class="language-plaintext highlighter-rouge">listening</code>, √† <code class="language-plaintext highlighter-rouge">true</code> quand le micro est en cours d‚Äô√©coute, <code class="language-plaintext highlighter-rouge">false</code> sinon.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">SwiftUI</span>

<span class="kd">@main</span>
<span class="kd">struct</span> <span class="kt">SpeechRecognitionApp</span><span class="p">:</span> <span class="kt">App</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">Scene</span> <span class="p">{</span>
        <span class="kt">WindowGroup</span> <span class="p">{</span>
            <span class="kt">SpeechRecognitionRootView</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">SpeechRecognitionRootView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>    
    <span class="kd">@State</span> <span class="k">var</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">SpeechRecognitionController</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>      
        <span class="kt">HStack</span> <span class="p">{</span>    
            <span class="k">if</span> <span class="o">!</span><span class="n">controller</span><span class="o">.</span><span class="n">listening</span> <span class="p">{</span>
                <span class="kt">Button</span><span class="p">(</span><span class="s">"Start"</span><span class="p">)</span> <span class="p">{</span> <span class="n">controller</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span> <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kt">Button</span><span class="p">(</span><span class="s">"Stop"</span><span class="p">)</span> <span class="p">{</span> <span class="n">controller</span><span class="o">.</span><span class="nf">stop</span><span class="p">()</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">listening</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"Listening"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@Observable</span>
<span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">listening</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// TODO</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// TODO</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="v√©rifier-la-permission-dacc√®s-au-micro">V√©rifier la permission d‚Äôacc√®s au micro</h2>

<p>L‚Äôacc√®s au micro peut √™tre autoris√©, refus√©/restreint ou ind√©termin√© :</p>

<ul>
  <li>
    <p>Le cas <em>autoris√©</em> correspond au cas o√π l‚Äôutilisateur a explicitement autoris√© l‚Äôacc√®s.</p>
  </li>
  <li>
    <p>Le cas <em>refus√©</em> correspond au cas o√π l‚Äôutilisateur a explicitement refus√© l‚Äôacc√®s.</p>
  </li>
  <li>
    <p>Le cas <em>restreint</em> correspond au cas o√π le syst√®me impose des restrictions, comme dans le cas d‚Äôun contr√¥le parental par exemple. Ici on consid√®re ce cas √©quivalent √† <em>refus√©</em>.</p>
  </li>
  <li>
    <p>Le cas ind√©termin√© correspond √† la situation dans laquelle l‚Äôapp n‚Äôa encore jamais demand√© la permission.</p>
  </li>
</ul>

<p>Dans le contr√¥leur j‚Äôajoute un un bool√©en optionnel qui refl√®tera l‚Äô√©tat de l‚Äôautorisation d‚Äôacc√®s au micro.
Une valeur <code class="language-plaintext highlighter-rouge">nil</code> correspond √† un √©tat ind√©termin√©, <code class="language-plaintext highlighter-rouge">true</code> si autoris√©, et <code class="language-plaintext highlighter-rouge">false</code> dans les autres cas.</p>

<p>Dans la vue j‚Äôaffiche la valeur de l‚Äôautorisation.
Je cr√©e aussi une propri√©t√© calcul√©e <code class="language-plaintext highlighter-rouge">ready</code> qui permet d‚Äôajuster l‚Äôinterface dans le cas o√π la permission micro est refus√©e. En l‚Äôoccurence on d√©sactive le bouton <strong>Start</strong>.</p>

<p>Par la suite on demandera l‚Äôautorisation au moment o√π l‚Äôutilisateur‚Ä¢ice clic sur le bouton <strong>Start</strong>.
Il faut donc que celui-ci soit actif dans le cas o√π la permission est encore ind√©termin√©e.
De mani√®re g√©n√©rale, quand la permission est encore ind√©termin√©e, il est plus engagent pour l‚Äôutilisateur‚Ä¢ice de pr√©senter l‚Äôinterface comme si elle √©tait autoris√©e, et de ne la d√©sactiver que lorsque la premission est explicitement refus√©e.
C‚Äôest pour cette raison que <code class="language-plaintext highlighter-rouge">ready</code> ne renvoit <code class="language-plaintext highlighter-rouge">false</code> que dans le cas o√π la premission est connue et refus√©e, et <code class="language-plaintext highlighter-rouge">true</code> dans tous les autres cas.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">SpeechRecognitionRootView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@State</span> <span class="k">var</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">SpeechRecognitionController</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Grid</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">leading</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">GridRow</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"Microphone authorisation"</span><span class="p">)</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">authorized</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">microphoneAuthorized</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">authorized</span> <span class="p">?</span> <span class="s">"Granted"</span> <span class="p">:</span> <span class="s">"Denied"</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="s">"undetermined"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="kt">HStack</span> <span class="p">{</span>    
                <span class="k">if</span> <span class="o">!</span><span class="n">controller</span><span class="o">.</span><span class="n">listening</span> <span class="p">{</span>
                    <span class="kt">Button</span><span class="p">(</span><span class="s">"Start"</span><span class="p">)</span> <span class="p">{</span> <span class="n">controller</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span> <span class="p">}</span>
                    <span class="o">.</span><span class="nf">disabled</span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// ...</span>
                <span class="p">}</span>
                <span class="c1">// ...</span>
            <span class="p">}</span>  
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nv">ready</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span>   
        <span class="k">if</span> <span class="k">let</span> <span class="nv">authorized</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">microphoneAuthorized</span><span class="p">,</span> <span class="n">authorized</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@Observable</span>
<span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>    
    <span class="c1">// ...</span>
    <span class="k">var</span> <span class="nv">microphoneAuthorized</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ensuite dans le contr√¥leur je cr√©e une propri√©t√© calcul√©e pour encapsuler l‚Äôappel √† la fonction syst√®me <code class="language-plaintext highlighter-rouge">AVCaptureDevice.authorizationStatus(for:)</code>, en indiquant qu‚Äôon souhaite acc√©der √† l‚Äôaudio.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">AVFoundation</span>

<span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">var</span> <span class="nv">microphoneAuthorisationStatus</span><span class="p">:</span> <span class="kt">AVAuthorizationStatus</span> <span class="p">{</span>
        <span class="kt">AVCaptureDevice</span><span class="o">.</span><span class="nf">authorizationStatus</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="n">audio</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Je cr√©e ensuite une fonction qui met √† jour la propri√©t√© observable en fonction de la valeur brute de la permission.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">func</span> <span class="nf">updateMicrophoneAuthorisationStatus</span><span class="p">()</span> <span class="p">{</span>   
        <span class="n">microphoneAuthorized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">microphoneAuthorisationStatus</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">notDetermined</span><span class="p">:</span> <span class="kc">nil</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">authorized</span><span class="p">:</span> <span class="kc">true</span>
            <span class="k">default</span><span class="p">:</span> <span class="kc">false</span>
            <span class="p">}</span>
        <span class="p">}()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">microphoneAuthorized</code> pourrait √™tre une propri√©t√© calcul√©e, mais on n‚Äôaurait alors aucun moyen de communiquer les changements √† la vue. L‚Äôobservation n√©cessite une propri√©t√© stock√©e. C‚Äôest la mise √† jour explicite de la propri√©t√© qui va d√©clencher la mise √† jour de la vue. La contrepartie est qu‚Äôil faut penser √† appeler <code class="language-plaintext highlighter-rouge">updateMicrophoneAuthorisationStatus()</code> aux moments opportuns.</p>

<p>Un moment opportun pour mettre √† jour la valeur est au d√©marrage, j‚Äôajoute donc un initialiseur dans le contr√¥leur qui fait une premi√®re mise √† jour.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="nf">updateMicrophoneAuthorisationStatus</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ainsi quand l‚Äôapp d√©marre l‚Äôaffichage refl√®te la bonne valeur de l‚Äôautorisation.</p>

<h2 id="demander-la-permission-dacc√®s-au-micro">Demander la permission d‚Äôacc√®s au micro</h2>

<p>Il faut maintenant demander la permission d‚Äôacc√®s au micro.</p>

<p>Je cr√©e encore une fois une fonction pour encapsuler l‚Äôappel √† la fonction syst√®me. La fonction est <code class="language-plaintext highlighter-rouge">AVCaptureDevice.requestAccess(for:)</code>, elle renvoie un bool√©en √† <code class="language-plaintext highlighter-rouge">true</code> si autoris√©, <code class="language-plaintext highlighter-rouge">false</code> sinon.
Ma m√©thode renvoie plut√¥t la valeur compl√®te de l‚Äôautorisation, apr√®s avoir mis √† jour la propri√©t√©.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">func</span> <span class="nf">requestMicrophoneAuthorisation</span><span class="p">()</span> <span class="k">async</span> <span class="o">-&gt;</span> <span class="kt">AVAuthorizationStatus</span> <span class="p">{</span>
        <span class="k">await</span> <span class="kt">AVCaptureDevice</span><span class="o">.</span><span class="nf">requestAccess</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="n">audio</span><span class="p">)</span>
        <span class="nf">updateMicrophoneAuthorisationStatus</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">microphoneAuthorisationStatus</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A noter que si l‚Äôapp a d√©j√† demand√© la permission et que l‚Äô√©tat d‚Äôautorisation est donc connu, <code class="language-plaintext highlighter-rouge">AVCaptureDevice.requestAccess(for:)</code> ne fait rien du tout.
Dans le cas contraire une bo√Æte de dialogue demande √† l‚Äôutilisateur s‚Äôil souhaite autoriser l‚Äôacc√®s ou non.
On peut donc appeler la m√©thode <code class="language-plaintext highlighter-rouge">requestMicrophoneAuthorisation()</code> de mani√®re syst√©matique pour r√©cup√©rer l‚Äô√©tat de l‚Äôautorisation, la question √©tant pr√©alablement pos√©e √† l‚Äôutilisateur si n√©cessaire.</p>

<p>Techniquement, demander la permission d‚Äôacc√®s au micro et utiliser le micro sont deux choses diff√©rentes qui peuvent se produire √† des moments diff√©rents. Et on pourrait tout √† fait demander la permission au d√©marrage de l‚Äôapplication ou √† l‚Äôarriv√©e sur l‚Äô√©cran. Cependant, demander la permission √† l‚Äôutilisateur‚Ä¢ice lui donne l‚Äôimpression qu‚Äôon va utiliser le micro imm√©diatement. Il est donc pr√©f√©rable de faire la demande au moment o√π on va r√©ellement l‚Äôutiliser.</p>

<p>C‚Äôest pourquoi j‚Äôappelle la m√©thode <code class="language-plaintext highlighter-rouge">requestMicrophoneAuthorisation()</code> dans la fonction <code class="language-plaintext highlighter-rouge">start()</code> et non dans l‚Äô<code class="language-plaintext highlighter-rouge">init()</code>.
Comme <code class="language-plaintext highlighter-rouge">requestMicrophoneAuthorisation()</code> est <code class="language-plaintext highlighter-rouge">async</code>, je modifie <code class="language-plaintext highlighter-rouge">start()</code> pour l‚Äô√™tre √©galement, et je modifie l‚Äôaction du bouton <strong>Start</strong> en cons√©quence.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">SpeechRecognitionRootView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@State</span> <span class="k">var</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">SpeechRecognitionController</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Grid</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">leading</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ...</span>
            <span class="kt">HStack</span> <span class="p">{</span>    
                <span class="k">if</span> <span class="o">!</span><span class="n">controller</span><span class="o">.</span><span class="n">listening</span> <span class="p">{</span>
                    <span class="kt">Button</span><span class="p">(</span><span class="s">"Start"</span><span class="p">)</span> <span class="p">{</span> <span class="kt">Task</span> <span class="p">{</span> <span class="k">await</span> <span class="n">controller</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span> <span class="p">}}</span>
                    <span class="o">.</span><span class="nf">disabled</span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// ...</span>
                <span class="p">}</span>
                <span class="c1">// ...</span>
            <span class="p">}</span>  
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">@Observable</span>
<span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>    
    <span class="c1">// ...</span>
    <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="k">async</span> <span class="p">{</span>
        <span class="c1">// check permission, ask if needed</span>
        <span class="k">let</span> <span class="nv">microphoneStatus</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">requestMicrophoneAuthorisation</span><span class="p">()</span>
        <span class="k">guard</span> <span class="n">microphoneStatus</span> <span class="o">==</span> <span class="o">.</span><span class="n">authorized</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Microphone not authorized"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="c1">// next steps will follow here</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Une fois que l‚Äôapp a demand√© une premi√®re fois la permission, une entr√©e est cr√©√© dans les r√©glages de <strong>Confidentialit√©</strong> dans les <strong>R√©glages syst√®me</strong>.
L‚Äôutilisateur‚Ä¢ice peut ensuite modifier √† loisir la permission.</p>

<p>Une fois que l‚Äôentr√©e existe dans les r√©glages de <strong>Confidentialit√©</strong>, la bo√Æte de dialogue d‚Äôautorisation ne s‚Äôaffiche plus √† l‚Äôutilisateur‚Ä¢ice.
C‚Äôest emb√™tant pour le d√©veloppement, o√π on aimerait pouvoir revenir dans un √©tat de permission ind√©termin√©e.</p>

<p>La commande suivante permet de supprimer l‚Äôentr√©e dans les r√©glages de <strong>Confidentialit√©</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tccutil reset Microphone &lt;bundle.id&gt;
</code></pre></div></div>

<p>Attention si <code class="language-plaintext highlighter-rouge">&lt;bundle id&gt;</code> n‚Äôest pas pr√©cis√©, la permission est r√©initialis√©e pour <strong>toutes</strong> les apps du syst√®me.</p>

<h2 id="acc√©der-aux-donn√©es-audio">Acc√©der aux donn√©es audio</h2>

<p>Tout est enfin pr√™t pour recevoir les donn√©es audio !
Pour √ßa on utilise <code class="language-plaintext highlighter-rouge">AVAudioEngine</code>.</p>

<p>Je cr√©e une nouvelle fonction <code class="language-plaintext highlighter-rouge">startAudio()</code> qui initialise une instance de <code class="language-plaintext highlighter-rouge">AVAudioEngine</code> dans et r√©cup√®re le noeud d‚Äôentr√©e.
On configure ensuite un ‚Äútap‚Äù sur le noeud d‚Äôentr√©e qui nous permet de r√©cup√©rer les donn√©es audio brute dans un buffer. La callback est appel√©e √† de multiples reprises avec le flux de donn√©es.
Enfin on appelle <code class="language-plaintext highlighter-rouge">.prepare()</code> et <code class="language-plaintext highlighter-rouge">.start()</code> sur <code class="language-plaintext highlighter-rouge">audioEngine</code> pour lancer l‚Äô√©coute.</p>

<p>Je cr√©e aussi une fonction <code class="language-plaintext highlighter-rouge">stopAudio()</code> qui arr√™te l‚Äô<code class="language-plaintext highlighter-rouge">audioEngine</code> et supprime le tap.
On appelle <code class="language-plaintext highlighter-rouge">startAudio()</code> dans <code class="language-plaintext highlighter-rouge">start()</code> et <code class="language-plaintext highlighter-rouge">stopAudio()</code> dans <code class="language-plaintext highlighter-rouge">stop()</code>, et on peut mettre √† jour le flag <code class="language-plaintext highlighter-rouge">listening</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">var</span> <span class="nv">audioEngine</span><span class="p">:</span> <span class="kt">AVAudioEngine</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">inputNode</span><span class="p">:</span> <span class="kt">AVAudioInputNode</span><span class="o">!</span>

    <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="k">async</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">try</span> <span class="nf">startAudio</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to start audio: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">listening</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>   
        <span class="nf">stopAudio</span><span class="p">()</span>
        <span class="n">listening</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">startAudio</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="n">audioEngine</span> <span class="o">=</span> <span class="kt">AVAudioEngine</span><span class="p">()</span>
        <span class="n">inputNode</span> <span class="o">=</span> <span class="n">audioEngine</span><span class="o">.</span><span class="n">inputNode</span>
        
        <span class="k">let</span> <span class="nv">recordingFormat</span> <span class="o">=</span> <span class="n">inputNode</span><span class="o">.</span><span class="nf">outputFormat</span><span class="p">(</span><span class="nv">forBus</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">inputNode</span><span class="o">.</span><span class="nf">installTap</span><span class="p">(</span><span class="nv">onBus</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">bufferSize</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="nv">format</span><span class="p">:</span> <span class="n">recordingFormat</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">in</span>
            <span class="c1">// receive audio data from buffer</span>
        <span class="p">}</span>
        
        <span class="n">audioEngine</span><span class="o">.</span><span class="nf">prepare</span><span class="p">()</span>
        <span class="k">try</span> <span class="n">audioEngine</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">stopAudio</span><span class="p">()</span> <span class="p">{</span>   
        <span class="n">audioEngine</span><span class="o">.</span><span class="nf">stop</span><span class="p">()</span>
        <span class="n">inputNode</span><span class="o">.</span><span class="nf">removeTap</span><span class="p">(</span><span class="nv">onBus</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Et voil√†, tout est pr√™t pour transmettre les donn√©es audio au module de reconnaissance vocale.</p>

  </div><a class="u-url" href="/2025/02/28/swiftui-microphone_fr.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper" style="display: flex; justify-content: space-between">

    <div class="description">
        <p></p>
        <p>üë®‚Äçüíªüßë‚Äçüî¨ü•Ωüç£ü•®üö¥‚Äç‚ôÇÔ∏èüéÆüõ∞Ô∏èüéÜüì∫üî≠</p>
    </div>

    <ul class="social-media-list" style="text-align: left">
        <li>
            <a href="https://github.com/alexbinary">
                <svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg>
                <span class="username">alexbinary</span>
            </a>
        </li>
        <li>
            <a href="https://www.twitter.com/AlexFrom1991">
                <svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg>
                <span class="username">AlexFrom1991</span>
            </a>
        </li>
        <li>
            <a href="mailto:alexandre@bintz.xyz">
                <svg fill="#828282" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="#828282" width=18><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M22,5V9L12,13,2,9V5A1,1,0,0,1,3,4H21A1,1,0,0,1,22,5ZM2,11.154V19a1,1,0,0,0,1,1H21a1,1,0,0,0,1-1V11.154l-10,4Z"></path></g></svg>
                &nbsp;alexandre@bintz.xyz
            </a>
        </li>
    </ul>

  </div>

</footer>
<script src="/assets/js/external-links.js"></script>

  </body>

</html>
