<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title></title>
    <meta name="description" content="" />
    <meta name="author" content="Alexandre Bintz" />

    <meta property="og:title" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta property="og:locale" content="" />
    <meta property="og:type" content="website" />
    
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="" />

    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="/assets/css/custom.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Alexandre Bintz" /><link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
</head><body><header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" rel="author" href="/">Alexandre Bintz</a>

    <div class="lang-and-menu">

      

      <nav class="lang-select">
        
        
          
          

          
            <a href="/" class="lang" title="Switch to English">üá∫üá∏</a>
          
        
          
          

          
            <a href="/fr" class="lang" title="Passer en fran√ßais">üá´üá∑</a>
          
        

      </nav>

    </div>
    
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">

      

      
      

      

        <div class="lang-available-banner">
          <div class="lang-available-banner-content">
            <p></p>
          </div>  
        </div>

        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">(fr) Reconnaissance vocale dans une app SwiftUI</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-03-14T04:23:06-05:00" itemprop="datePublished">Mar 14, 2025
      </time></p>
      
      
        <div class="post-topics">
          
            <a href="/programming"><i>#programming</i></a>
          
        </div>
      
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Dans un pr√©c√©dent article, nous avons vu l‚Äôacc√®s au microphone dans une application SwiftUI sur macOS.
Dans cet article nous allons ajouter la reconnaissance vocale avec le framework <a href="https://developer.apple.com/documentation/speech">Speech</a>.</p>

<h2 id="v√©rifier-la-permission">V√©rifier la permission</h2>

<p>Comme pour l‚Äôacc√®s au micro, l‚Äôutilisateur‚Ä¢ice doit autoriser notre app √† utiliser la reconnaissance vocale.
Le principe est similaire √† la permission micro,
les cas possibles sont: autoris√©, refus√©/restreint ou ind√©termin√©.</p>

<p>Comme pour le micro, je commence par ajouter dans le contr√¥leur un un bool√©en optionnel qui refl√®tera l‚Äô√©tat de l‚Äôautorisation d‚Äôacc√®s √† la reconnaissance vocale, j‚Äôaffiche la valeur de l‚Äôautorisation dans la vue, et je modifie la propri√©t√© <code class="language-plaintext highlighter-rouge">ready</code> pour prendre en compte la reconnaissance vocale.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">SpeechRecognitionRootView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@State</span> <span class="k">var</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">SpeechRecognitionController</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Grid</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">leading</span><span class="p">,</span> <span class="nv">verticalSpacing</span><span class="p">:</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ...</span>
            <span class="kt">GridRow</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"Speech recognition authorisation"</span><span class="p">)</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">authorized</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">speechRecognitionAuthorized</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">authorized</span> <span class="p">?</span> <span class="s">"Granted"</span> <span class="p">:</span> <span class="s">"Denied"</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="s">"undetermined"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="kt">HStack</span> <span class="p">{</span>
                <span class="c1">// ...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nv">ready</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">authorized</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">speechRecognitionAuthorized</span><span class="p">,</span> <span class="n">authorized</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@Observable</span>
<span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>   
    <span class="c1">//...</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">speechRecognitionAuthorized</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span>
<span class="p">}</span>
</code></pre></div></div>

<p>La fonction syst√®me qui indique l‚Äôautorisation de la reconnaissance vocale est <code class="language-plaintext highlighter-rouge">SFSpeechRecognizer.authorizationStatus()</code>.
Comme pour le micro, je cr√©e une propri√©t√© calcul√©e dans le contr√¥leur pour encapsuler l‚Äôappel √† la fonction syst√®me, et une fonction qui met √† jour la propri√©t√© observable en fonction de la valeur brute de la permission, et je fais une premi√®re mise √† jour dans l‚Äôinitialiseur.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Speech</span>

<span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>   
    <span class="c1">//...</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">speechRecognitionAuthorisationStatus</span><span class="p">:</span> <span class="kt">SFSpeechRecognizerAuthorizationStatus</span> <span class="p">{</span>
        <span class="kt">SFSpeechRecognizer</span><span class="o">.</span><span class="nf">authorizationStatus</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">updateSpeechRecognitionAuthorisationStatus</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">speechRecognitionAuthorized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">speechRecognitionAuthorisationStatus</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">notDetermined</span><span class="p">:</span> <span class="kc">nil</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">authorized</span><span class="p">:</span> <span class="kc">true</span>
            <span class="k">default</span><span class="p">:</span> <span class="kc">false</span>
            <span class="p">}</span>
        <span class="p">}()</span>
    <span class="p">}</span>
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//...</span>
        <span class="nf">updateSpeechRecognitionAuthorisationStatus</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="demander-la-permission">Demander la permission</h2>

<p>La fonction syst√®me pour demander la permission est <code class="language-plaintext highlighter-rouge">SFSpeechRecognizer.requestAuthorization(:)</code>.
Elle renvoie la valeur de l‚Äôautorisation dans une closure.
Comme pour le micro, je cr√©e une fonction qui encapsule l‚Äôappel √† la fonction syst√®me et renvoie la valeur de l‚Äôautorisation.
J‚Äôutilise <code class="language-plaintext highlighter-rouge">withCheckedContinuation(:)</code> pour utiliser <code class="language-plaintext highlighter-rouge">async/await</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">//...</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">requestSpeechRecognitionAuthorisation</span><span class="p">()</span> <span class="k">async</span> <span class="o">-&gt;</span> <span class="kt">SFSpeechRecognizerAuthorizationStatus</span> <span class="p">{</span>
        <span class="k">await</span> <span class="n">withCheckedContinuation</span> <span class="p">{</span> <span class="n">continuation</span> <span class="k">in</span>
            <span class="kt">SFSpeechRecognizer</span><span class="o">.</span><span class="n">requestAuthorization</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
                <span class="k">self</span><span class="o">.</span><span class="nf">updateSpeechRecognitionAuthorisationStatus</span><span class="p">()</span>
                <span class="n">continuation</span><span class="o">.</span><span class="nf">resume</span><span class="p">(</span><span class="nv">returning</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">speechRecognitionAuthorisationStatus</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Comme pour le micro, on peut appeler la m√©thode <code class="language-plaintext highlighter-rouge">requestSpeechRecognitionAuthorisation()</code> de mani√®re syst√©matique pour r√©cup√©rer l‚Äô√©tat de l‚Äôautorisation, la question n‚Äôest pos√©e √† l‚Äôutilisateur que si n√©cessaire.</p>

<p>J‚Äôappelle cette fonction dans <code class="language-plaintext highlighter-rouge">start()</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">//...</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="k">async</span> <span class="p">{</span>
        <span class="c1">//...</span>
        <span class="k">let</span> <span class="nv">speechRecognitonStatus</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">requestSpeechRecognitionAuthorisation</span><span class="p">()</span>
        <span class="k">guard</span> <span class="n">speechRecognitonStatus</span> <span class="o">==</span> <span class="o">.</span><span class="n">authorized</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Speech recognition not authorized (</span><span class="se">\(</span><span class="n">speechRecognitonStatus</span><span class="se">)</span><span class="s">)"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>La commande suivante permet de r√©initialiser la demande de permission, utile en d√©veloppement.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tccutil reset SpeechRecognition &lt;bundle.id&gt;
</code></pre></div></div>

<h2 id="initialisation-et-v√©rification-de-la-disponibilit√©">Initialisation et v√©rification de la disponibilit√©</h2>

<p>Tout est d√©sormais pr√™t pour d√©marrer la reconnaissance vocale.
La classe principale est <code class="language-plaintext highlighter-rouge">SFSpeechRecognizer</code>.
Dans le contr√¥leur j‚Äôajoute une propri√©t√© qui permettra de stocker une instance de cette classe.
Bien que le contr√¥leur pourra d√©marrer et arr√™ter la reconnaissance vocale √† loisir,
une seule instance de <code class="language-plaintext highlighter-rouge">SFSpeechRecognizer</code> est n√©cessaire.</p>

<p>Par d√©faut la reconnaissance vocale reconnait la langue configur√©e sur l‚Äôappareil,
mais il est possible de passer une locale sp√©cifique.
Ici je force la langue fran√ßaise dans sa variante de France.</p>

<p>La reconnaissance vocale peut ne pas √™tre disponible sur un appareil donn√© √† un instant donn√©,
notamment par rapport √† l‚Äô√©tat de la connexion Internet.
La disponibilit√© en temps r√©el est donn√©e par la fonction <code class="language-plaintext highlighter-rouge">SFSpeechRecognizerDelegate.speechRecognizer(_:availabilityDidChange:)</code>.
J‚Äôimpl√©mente cette fonction sur le contr√¥leur et configure le <code class="language-plaintext highlighter-rouge">delegate</code> de l‚Äôobjet <code class="language-plaintext highlighter-rouge">SFSpeechRecognizer</code>.
√Ä noter qu‚Äôil existe aussi la propri√©t√© <code class="language-plaintext highlighter-rouge">SFSpeechRecognizer.isAvailable</code> qui permet d‚Äôinterroger directement la disponibilit√©.</p>

<p>Pour une exp√©rience utilisateur optimale, il est pr√©f√©rable d‚Äôajuster l‚Äôaffichage et le comportement de l‚Äôapplication selon la possibilit√© d‚Äôutiliser ou non la reconnaissance vocale d√®s le d√©marrage.
Si on attend que l‚Äôutilisateur‚Ä¢ice essaie d‚Äôacc√©der aux fonctionnalit√©s associ√©es pour le v√©rifier,
on risque de cr√©er de la frustration si ces fonctionnalit√©s s‚Äôav√®rent indisponibles.
J‚Äôinitialise donc l‚Äôinstance <code class="language-plaintext highlighter-rouge">SFSpeechRecognizer</code> dans l‚Äôinitialiseur.</p>

<p>Dans la vue j‚Äôaffiche la disponibilit√© de la reconnaissance vocale, et je modifie <code class="language-plaintext highlighter-rouge">ready</code> pour prendre en compte cette nouvelle donn√©e.
Dans ce cas, on n‚Äôautorise que si on est s√ªr que la fonctionnalit√© est disponible.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">SpeechRecognitionRootView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@State</span> <span class="k">var</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">SpeechRecognitionController</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Grid</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">leading</span><span class="p">,</span> <span class="nv">verticalSpacing</span><span class="p">:</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ...</span>
            <span class="kt">GridRow</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"Speech recognition availability"</span><span class="p">)</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">available</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">speechRecognitionAvailable</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">available</span> <span class="p">?</span> <span class="s">"Available"</span> <span class="p">:</span> <span class="s">"Unavailable"</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="s">"undetermined"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="kt">HStack</span> <span class="p">{</span>
                <span class="c1">// ...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nv">ready</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">speechRecognitionAvailable</span> <span class="o">!=</span> <span class="kc">true</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@Observable</span>
<span class="kd">class</span> <span class="kt">SpeechRecognitionController</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">SFSpeechRecognizerDelegate</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">var</span> <span class="nv">speechRecognizer</span><span class="p">:</span> <span class="kt">SFSpeechRecognizer</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">speechRecognitionAvailable</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span>
    <span class="c1">// ...</span>
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="c1">// ...</span>
        <span class="c1">// init speech recognizer with forced locale</span>
        <span class="k">let</span> <span class="nv">locale</span> <span class="o">=</span> <span class="kt">Locale</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="s">"fr_FR"</span><span class="p">)</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">recognizer</span> <span class="o">=</span> <span class="kt">SFSpeechRecognizer</span><span class="p">(</span><span class="nv">locale</span><span class="p">:</span> <span class="n">locale</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Unable to create a SFSpeechRecognizer object with locale </span><span class="se">\(</span><span class="n">locale</span><span class="se">)</span><span class="s">"</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">speechRecognizer</span> <span class="o">=</span> <span class="n">recognizer</span>
        <span class="n">speechRecognizer</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Speech recognition ready, using locale </span><span class="se">\(</span><span class="n">locale</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">speechRecognizer</span><span class="p">(</span><span class="n">_</span> <span class="nv">speechRecognizer</span><span class="p">:</span> <span class="kt">SFSpeechRecognizer</span><span class="p">,</span> <span class="n">availabilityDidChange</span> <span class="nv">available</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">speechRecognitionAvailable</span> <span class="o">=</span> <span class="n">available</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="d√©marrage-de-la-reconnaissance-et-traitement-des-r√©sultats">D√©marrage de la reconnaissance et traitement des r√©sultats</h2>

<p>On peut maintenant lancer la reconnaissance vocale √† proprement parler lorsque l‚Äôutilisateur‚Ä¢ice clique sur <strong>Start</strong>.
Je commence par cr√©er des fonctions <code class="language-plaintext highlighter-rouge">startRecognition()</code> et <code class="language-plaintext highlighter-rouge">stopRecognition()</code>, que j‚Äôappelle respectivement dans <code class="language-plaintext highlighter-rouge">start()</code> et <code class="language-plaintext highlighter-rouge">stop()</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="k">async</span> <span class="p">{</span>
        <span class="c1">// ... (check permissions)</span>
        <span class="c1">// ... (start audio)</span>
        
        <span class="nf">startRecognition</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Recognition active"</span><span class="p">)</span>
        
        <span class="n">listening</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">stopRecognition</span><span class="p">()</span>
        <span class="nf">stopAudio</span><span class="p">()</span>
        <span class="n">listening</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">startRecognition</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// TODO</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">stopRecognition</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// TODO</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Pour une session de reconnaissance nous avons besoin d‚Äôune instance de <code class="language-plaintext highlighter-rouge">SFSpeechAudioBufferRecognitionRequest</code> et <code class="language-plaintext highlighter-rouge">SFSpeechRecognitionTask</code>.
J‚Äôajoute deux propri√©t√©s correspondantes dans le contr√¥leur.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">recognitionRequest</span><span class="p">:</span> <span class="kt">SFSpeechAudioBufferRecognitionRequest</span><span class="o">!</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">recognitionTask</span><span class="p">:</span> <span class="kt">SFSpeechRecognitionTask</span><span class="o">!</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>On commence par initialiser une requ√™te.
Ensuite il faut alimenter la requ√™te avec les donn√©es audio issues du micro.
Pour cela on utilise le ‚Äútap‚Äù mis en place pr√©c√©dement.
Enfin, on lance une t√¢che de reconnaissance vocale √† partir de la requ√™te.
Les r√©sultats sont envoy√©s √† une closure au fur et √† mesure que la personne parle.
<code class="language-plaintext highlighter-rouge">result.bestTranscription</code> contient la transcription des paroles prononc√©es.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">startRecognition</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">recognitionRequest</span> <span class="o">=</span> <span class="kt">SFSpeechAudioBufferRecognitionRequest</span><span class="p">()</span>
        
        <span class="k">let</span> <span class="nv">recordingFormat</span> <span class="o">=</span> <span class="n">inputNode</span><span class="o">.</span><span class="nf">outputFormat</span><span class="p">(</span><span class="nv">forBus</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">inputNode</span><span class="o">.</span><span class="nf">installTap</span><span class="p">(</span><span class="nv">onBus</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">bufferSize</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="nv">format</span><span class="p">:</span> <span class="n">recordingFormat</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="n">recognitionRequest</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">recognitionTask</span> <span class="o">=</span> <span class="n">speechRecognizer</span><span class="o">.</span><span class="nf">recognitionTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">recognitionRequest</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Recognition error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">result</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">recognizedText</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">bestTranscription</span><span class="o">.</span><span class="n">formattedString</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Pour l‚Äôarr√™t de la reconnaissance, on peut appeler <code class="language-plaintext highlighter-rouge">recognitionTask.finish()</code> et <code class="language-plaintext highlighter-rouge">recognitionRequest.endAudio()</code>, et enlever le tap.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">SpeechRecognitionController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">stopRecognition</span><span class="p">()</span> <span class="p">{</span>
        
        <span class="n">recognitionRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">endAudio</span><span class="p">()</span>
        <span class="n">recognitionRequest</span> <span class="o">=</span> <span class="kc">nil</span>
        
        <span class="n">recognitionTask</span><span class="p">?</span><span class="o">.</span><span class="nf">finish</span><span class="p">()</span>
        <span class="n">recognitionTask</span> <span class="o">=</span> <span class="kc">nil</span>
        
        <span class="n">inputNode</span><span class="o">.</span><span class="nf">removeTap</span><span class="p">(</span><span class="nv">onBus</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Et voil√†, tout est fonctionnel.</p>

<p><img src="/assets/2025-03-14-swiftui-speech/1.gif" alt="" /></p>

  </div><a class="u-url" href="/2025/03/14/swiftui-speech_fr.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper" style="display: flex; justify-content: space-between">

    <div class="description">
        <p></p>
        <p>üë®‚Äçüíªüßë‚Äçüî¨ü•Ωüç£ü•®üö¥‚Äç‚ôÇÔ∏èüéÆüõ∞Ô∏èüéÜüì∫üî≠</p>
    </div>

    <ul class="social-media-list" style="text-align: left">
        <li>
            <a href="https://github.com/alexbinary">
                <svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg>
                <span class="username">alexbinary</span>
            </a>
        </li>
        <li>
            <a href="https://www.twitter.com/AlexFrom1991">
                <svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg>
                <span class="username">AlexFrom1991</span>
            </a>
        </li>
        <li>
            <a href="mailto:alexandre@bintz.xyz">
                <svg fill="#828282" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="#828282" width=18><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M22,5V9L12,13,2,9V5A1,1,0,0,1,3,4H21A1,1,0,0,1,22,5ZM2,11.154V19a1,1,0,0,0,1,1H21a1,1,0,0,0,1-1V11.154l-10,4Z"></path></g></svg>
                &nbsp;alexandre@bintz.xyz
            </a>
        </li>
    </ul>

  </div>

</footer>
<script src="/assets/js/external-links.js"></script>

  </body>

</html>
